{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import fs from \"fs\";\nimport Module from \"module\";\nimport type { TransformOptions } from \"esbuild\";\nimport { transformSync } from \"esbuild\";\n\ninterface _Module extends Module {\n  _compile(compiled: string, filename: string): any;\n}\n\n/**\n * Register a `require` hook that transforms ESM files.\n * @param options Optional additional `esbuild` transform options.\n * @returns An unregister function that restores the state before registering.\n */\nexport function register(options?: TransformOptions) {\n  const transformOptions: TransformOptions = {\n    target: `node${process.versions.node.split(\".\")[0]}`,\n    format: \"cjs\",\n    loader: \"js\",\n    ...options,\n  };\n\n  function esbuild(module: _Module, filename: string) {\n    const source = fs.readFileSync(filename, \"utf-8\");\n    const result = transformSync(source, transformOptions).code;\n    return module._compile(result, filename);\n  }\n\n  const extensions: {\n    [extension: `.${string}`]: (module: _Module, filename: string) => void;\n  } = (Module as any)._extensions;\n\n  const js = extensions[\".js\"];\n  const mjs = extensions[\".mjs\"];\n\n  extensions[\".js\"] = function (module, filename) {\n    try {\n      return js(module, filename);\n    } catch (e) {\n      if (\n        e &&\n        (e.code === \"ERR_REQUIRE_ESM\" ||\n          e.message?.includes(\"Cannot use import statement outside a module\") ||\n          e.message?.includes(\"Unexpected token 'export'\"))\n      ) {\n        return esbuild(module, filename);\n      }\n      throw e;\n    }\n  };\n\n  extensions[\".mjs\"] ??= function (module, filename) {\n    return esbuild(module, filename);\n  };\n\n  return () => {\n    extensions[\".js\"] = js;\n    extensions[\".mjs\"] = mjs;\n  };\n}\n"],"names":["esbuild","fs","transformSync","Module"],"mappings":";;;;;;;;;;;;;;AASA;;;;AAIG;AACG,SAAU,QAAQ,CAAC,OAA0B,EAAA;AACjD,IAAA,MAAM,gBAAgB,GAAqB;AACzC,QAAA,MAAM,EAAE,CAAA,IAAA,EAAO,OAAO,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAE,CAAA;AACpD,QAAA,MAAM,EAAE,KAAK;AACb,QAAA,MAAM,EAAE,IAAI;AACZ,QAAA,GAAG,OAAO;KACX,CAAC;AAEF,IAAA,SAASA,SAAO,CAAC,MAAe,EAAE,QAAgB,EAAA;QAChD,MAAM,MAAM,GAAGC,sBAAE,CAAC,YAAY,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC;QAClD,MAAM,MAAM,GAAGC,qBAAa,CAAC,MAAM,EAAE,gBAAgB,CAAC,CAAC,IAAI,CAAC;QAC5D,OAAO,MAAM,CAAC,QAAQ,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;KAC1C;AAED,IAAA,MAAM,UAAU,GAEXC,0BAAc,CAAC,WAAW,CAAC;AAEhC,IAAA,MAAM,EAAE,GAAG,UAAU,CAAC,KAAK,CAAC,CAAC;AAC7B,IAAA,MAAM,GAAG,GAAG,UAAU,CAAC,MAAM,CAAC,CAAC;AAE/B,IAAA,UAAU,CAAC,KAAK,CAAC,GAAG,UAAU,MAAM,EAAE,QAAQ,EAAA;QAC5C,IAAI;AACF,YAAA,OAAO,EAAE,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;AAC7B,SAAA;AAAC,QAAA,OAAO,CAAC,EAAE;AACV,YAAA,IACE,CAAC;AACD,iBAAC,CAAC,CAAC,IAAI,KAAK,iBAAiB;AAC3B,oBAAA,CAAC,CAAC,OAAO,EAAE,QAAQ,CAAC,8CAA8C,CAAC;oBACnE,CAAC,CAAC,OAAO,EAAE,QAAQ,CAAC,2BAA2B,CAAC,CAAC,EACnD;AACA,gBAAA,OAAOH,SAAO,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;AAClC,aAAA;AACD,YAAA,MAAM,CAAC,CAAC;AACT,SAAA;AACH,KAAC,CAAC;IAEF,UAAU,CAAC,MAAM,CAAA,KAAjB,UAAU,CAAC,MAAM,CAAM,GAAA,UAAU,MAAM,EAAE,QAAQ,EAAA;AAC/C,QAAA,OAAOA,SAAO,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;AACnC,KAAC,CAAC,CAAA;AAEF,IAAA,OAAO,MAAK;AACV,QAAA,UAAU,CAAC,KAAK,CAAC,GAAG,EAAE,CAAC;AACvB,QAAA,UAAU,CAAC,MAAM,CAAC,GAAG,GAAG,CAAC;AAC3B,KAAC,CAAC;AACJ;;;;"}